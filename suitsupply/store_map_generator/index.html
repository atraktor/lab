<!DOCTYPE html>
<html>
<head>
  <title>Suitsupply Stores map generator</title>

  <script type="text/javascript" src="node_modules/jquery/dist/jquery.min.js"></script>
  <script type="text/javascript" src="node_modules/downloadjs/download.min.js"></script>
  <script type="text/javascript">

    (function($) {

      var gMapsAPI = 'https://maps.googleapis.com/maps/api/staticmap?maptype=roadmap',
      gMapsOptions =
      {
        zoom: 15,
        size: '420x160',
        scale: 1,
        format: 'png'
      },
      gMapsParams = [],
      markerURL = 'http://lab.nolten.co/suitsupply/store_map_generator/marker.png',
      apiKey = '',
      images = [],
      // ssStores = 'https://sheetsu.com/apis/v1.0/590765a01854',
      count = 1;

      var generateMaps = function(html) {

        var r = $.Deferred();

        $('#images').append(html);

        $('form').after('<input type="button" value="Download all maps">');

        map = $('#images').find('div');

        downloadAll(map);

        return r;

      };

      var downloadMap = function(el) {

        var a = el.find('a'),
            link = a.attr('href'),
            name = el.find('h1').text().replace(/\s/g, ''),
            x = new XMLHttpRequest();

          x.open( "GET", link , true);
          x.responseType="blob";
          x.onload= function(e){
            download(e.target.response, name + ".png", "image/png");
          };
          x.send();

      };

      var downloadAll = function(map) {
        
        var r = $.Deferred();

        $('input[type="button"]').click(function(e) {
          e.preventDefault();
          map.each(function() {

            downloadMap($(this));
            
          });
        });
      
        return r;
      };

      $.each(gMapsOptions, function(key,val) {
        var optionSet = key + '=' + val;
        gMapsParams.push(optionSet);
      });
      gMapsParams = '&' + gMapsParams.join('&');

      var jqxhr = $.getJSON( 'https://sheetsu.com/apis/v1.0/590765a01854', function(data) {

        $('form').submit(function( event ) {
          event.preventDefault();
          apiKey = $('input[type=text]').val();
          // count = $('input[type=number').val();

          $('#images').empty();

          $.each(data, function(key,val) {
            var address = val.Address.split(' ').join('+'),
            city = val.Coordinates.split(' ').join('+');
            coordinates = address + '+' + city,
            name = coordinates.split('+').join('') + '.png',
            gMapsImgURL = '',
            markers = '&markers=icon:' + markerURL + '%7C' + coordinates;

            if (coordinates.indexOf('_') != -1) { return };

            gMapsImgURL = gMapsAPI + '&center=' + coordinates + gMapsParams + '&key=' + apiKey + markers;

            images.push('<div><h1>' + val.Address + ' ' + val.Coordinates + '</h1><a href="' + gMapsImgURL + '"s><img src="' + gMapsImgURL + '" width="630" height="240"/></a></div>');

          });

          generateMaps(images);

        });

      });

    })(jQuery);

  </script>
  <link href="https://fonts.googleapis.com/css?family=Roboto+Condensed:300" rel="stylesheet">
  <style type="text/css">
    body {
      font-family: "Roboto Condensed";
      font-weight: 300;
    }
    input {
      font-size: 1.5em;
      padding: 0.5em;
    }
    a {
      display: block;
      margin-bottom: 4em;
    }
  </style>
</head>
<body>

  <form>
    <input type="text" name="Google Maps API key" placeholder="Your API key please">
    <!-- <input type="number" name="count" placeholder="How many maps"> -->
    <input type="submit" value="Generate those maps!">
  </form>

  <div id="images"></div>
  
</body>
</html>